<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal Harian Guru</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0f4f8; }
        .calendar-day { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 50%; transition: all 0.3s ease; }
        .calendar-day:hover { background-color: #e0f2fe; }
        .calendar-day.active { background-color: #0ea5e9; color: white; }
        .calendar-day.has-entry { border: 2px solid #0ea5e9; }
        .tab-active { color: #0ea5e9; border-bottom: 2px solid #0ea5e9; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media print {
            .no-print { display: none !important; }
            body { background-color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            #appContainer { display: block !important; }
            main { padding: 0 !important; }
            .print-container { padding: 1rem; }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
        <div class="loader"></div>
    </div>

    <!-- Auth Container -->
    <div id="authContainer" class="min-h-screen flex items-center justify-center bg-gradient-to-r from-blue-600 to-cyan-500">
        <div class="max-w-md w-full bg-white rounded-xl shadow-2xl p-8 space-y-6">
            <!-- Login View -->
            <div id="loginView">
                <h2 class="text-3xl font-bold text-center text-gray-800">Selamat Datang!</h2>
                <form id="loginForm" class="mt-8 space-y-6">
                    <input id="loginEmail" name="email" type="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Email">
                    <input id="loginPassword" name="password" type="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Password">
                    <button type="submit" class="w-full py-3 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-semibold">Masuk</button>
                    <p class="text-center text-sm">Belum punya akun? <a href="#" id="showRegister" class="font-medium text-blue-600">Daftar di sini</a></p>
                </form>
            </div>
            <!-- Register View -->
            <div id="registerView" class="hidden">
                <h2 class="text-3xl font-bold text-center text-gray-800">Buat Akun Baru</h2>
                <form id="registerForm" class="mt-8 space-y-6">
                     <input id="registerName" name="nama" type="text" required class="w-full px-4 py-3 border rounded-lg" placeholder="Nama Lengkap">
                    <input id="registerEmail" name="email" type="email" required class="w-full px-4 py-3 border rounded-lg" placeholder="Email">
                    <input id="registerPassword" name="password" type="password" required class="w-full px-4 py-3 border rounded-lg" placeholder="Password">
                    <button type="submit" class="w-full py-3 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-semibold">Daftar</button>
                    <p class="text-center text-sm">Sudah punya akun? <a href="#" id="showLogin" class="font-medium text-blue-600">Masuk di sini</a></p>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="hidden">
        <div class="min-h-screen flex flex-col">
            <!-- Header -->
            <header class="bg-gradient-to-r from-blue-600 to-cyan-500 text-white shadow-lg no-print">
                <div class="container mx-auto px-4 py-4">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold">Jurnal Harian Guru</h1>
                        <div class="flex items-center space-x-4">
                            <span id="welcomeMessage" class="hidden md:block"></span>
                            <button id="logoutBtn" class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg text-white font-semibold text-sm">Logout</button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="flex-grow container mx-auto px-4 py-6">
                <!-- Dashboard -->
                <div id="dashboard" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Left Column -->
                        <div class="md:col-span-2 space-y-6">
                            <!-- Quick Entry -->
                            <div class="bg-white rounded-xl shadow-md p-6">
                                <h2 class="text-xl font-semibold text-gray-800 mb-4">Entri Cepat</h2>
                                <div class="space-y-4">
                                    <input type="date" id="quickDate" class="w-full px-4 py-2 border rounded-lg">
                                    <select id="quickClass" class="w-full px-4 py-2 border rounded-lg"><option value="">Pilih Kelas</option><option>7A</option><option>7B</option><option>8A</option><option>8B</option><option>9A</option><option>9B</option></select>
                                    <select id="quickSubject" class="w-full px-4 py-2 border rounded-lg"><option value="">Pilih Mapel</option><option>Matematika</option><option>Bahasa Indonesia</option><option>IPA</option><option>IPS</option><option>Bahasa Inggris</option></select>
                                    <textarea id="quickActivity" rows="3" class="w-full px-4 py-2 border rounded-lg" placeholder="Deskripsi kegiatan..."></textarea>
                                    <div class="flex justify-end"><button id="quickSaveBtn" class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">Simpan</button></div>
                                </div>
                            </div>
                            <!-- Recent Entries -->
                            <div class="bg-white rounded-xl shadow-md p-6">
                                <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold">Entri Terbaru</h2><button id="viewAllBtn" class="text-blue-600 text-sm font-medium">Lihat Semua</button></div>
                                <div id="recentEntries" class="space-y-4"></div>
                            </div>
                        </div>
                        <!-- Right Column -->
                        <div class="space-y-6">
                            <!-- Calendar -->
                            <div class="bg-white rounded-xl shadow-md p-6">
                                <div class="flex justify-between items-center mb-4"><button id="prevMonth">‹</button><h3 id="currentMonth" class="text-lg font-medium"></h3><button id="nextMonth">›</button></div>
                                <div class="grid grid-cols-7 gap-1 text-sm text-gray-500 mb-2 text-center"><div>Min</div><div>Sen</div><div>Sel</div><div>Rab</div><div>Kam</div><div>Jum</div><div>Sab</div></div>
                                <div id="calendarDays" class="grid grid-cols-7 gap-1"></div>
                            </div>
                            <!-- Statistics -->
                            <div class="bg-white rounded-xl shadow-md p-6 space-y-4">
                                <h2 class="text-xl font-semibold">Statistik</h2>
                                <div class="flex justify-between"><span>Total Entri</span><span id="totalEntries" class="font-semibold">0</span></div>
                                <div class="flex justify-between"><span>Entri Minggu Ini</span><span id="weekEntries" class="font-semibold">0</span></div>
                                <div class="flex justify-between"><span>Kelas Terbanyak</span><span id="topClass" class="font-semibold">-</span></div>
                            </div>
                            <!-- Quick Links -->
                            <div class="bg-white rounded-xl shadow-md p-6">
                                <h2 class="text-xl font-semibold mb-4">Menu Cepat</h2>
                                <div class="grid grid-cols-2 gap-3">
                                    <button id="attendanceBtn" class="p-3 bg-green-50 rounded-lg hover:bg-green-100">Absensi</button>
                                    <button id="reportsBtn" class="p-3 bg-purple-50 rounded-lg hover:bg-purple-100">Laporan</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- All Entries View -->
                <div id="allEntriesView" class="hidden">
                    <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Semua Entri Jurnal</h2><button id="backToDashboard" class="text-blue-600">‹ Kembali</button></div>
                    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <input type="date" id="filterFromDate" class="w-full px-4 py-2 border rounded-lg">
                            <input type="date" id="filterToDate" class="w-full px-4 py-2 border rounded-lg">
                            <select id="filterClass" class="w-full px-4 py-2 border rounded-lg"><option value="">Semua Kelas</option><option>7A</option><option>7B</option><option>8A</option><option>8B</option><option>9A</option><option>9B</option></select>
                            <select id="filterSubject" class="w-full px-4 py-2 border rounded-lg"><option value="">Semua Mapel</option><option>Matematika</option><option>Bahasa Indonesia</option><option>IPA</option><option>IPS</option><option>Bahasa Inggris</option></select>
                        </div>
                        <div class="mt-4 flex justify-end"><button id="applyFilterBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg">Terapkan</button></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md overflow-hidden"><div class="overflow-x-auto"><table class="min-w-full divide-y"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium uppercase">Tanggal</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Kelas</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Mapel</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Kegiatan</th><th class="px-6 py-3 text-right text-xs font-medium uppercase">Aksi</th></tr></thead><tbody id="entriesTableBody" class="bg-white divide-y"></tbody></table></div><div id="noEntriesMessage" class="py-8 text-center hidden">Tidak ada entri.</div></div>
                </div>

                <!-- Attendance View -->
                <div id="attendanceView" class="hidden">
                     <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Absensi Siswa</h2><button id="backToDashboardFromAttendance" class="text-blue-600">‹ Kembali</button></div>
                     <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                        <div class="flex border-b"><button id="newAttendanceTab" class="px-4 py-2 font-medium tab-active">Absensi Baru</button><button id="attendanceHistoryTab" class="px-4 py-2 font-medium">Riwayat Absensi</button></div>
                        <div id="newAttendanceForm" class="pt-4"><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"><input type="date" id="attendanceDate" class="w-full px-4 py-2 border rounded-lg"><select id="attendanceClass" class="w-full px-4 py-2 border rounded-lg"><option value="">Pilih Kelas</option><option>7A</option><option>7B</option><option>8A</option><option>8B</option><option>9A</option><option>9B</option></select><select id="attendanceSubject" class="w-full px-4 py-2 border rounded-lg"><option value="">Pilih Mapel</option><option>Matematika</option><option>Bahasa Indonesia</option><option>IPA</option><option>IPS</option><option>Bahasa Inggris</option></select></div><button id="loadStudentsBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Muat Daftar Siswa</button><div id="studentListContainer" class="hidden mt-4"><div class="overflow-x-auto"><table class="min-w-full divide-y"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs uppercase">No</th><th class="px-6 py-3 text-left text-xs uppercase">Nama Siswa</th><th class="px-6 py-3 text-left text-xs uppercase">Status</th><th class="px-6 py-3 text-left text-xs uppercase">Keterangan</th></tr></thead><tbody id="studentListBody"></tbody></table></div><div class="mt-4 flex justify-end"><button id="saveAttendanceBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg">Simpan Absensi</button></div></div></div>
                        <div id="attendanceHistoryContent" class="pt-4 hidden"><div class="overflow-x-auto"><table class="min-w-full divide-y"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs uppercase">Tanggal</th><th class="px-6 py-3 text-left text-xs uppercase">Kelas</th><th class="px-6 py-3 text-left text-xs uppercase">Mapel</th><th class="px-6 py-3 text-left text-xs uppercase">Hadir</th><th class="px-6 py-3 text-left text-xs uppercase">Tidak Hadir</th><th class="px-6 py-3 text-right text-xs uppercase">Aksi</th></tr></thead><tbody id="attendanceHistoryBody"></tbody></table></div><div id="noAttendanceMessage" class="py-8 text-center hidden">Tidak ada data.</div></div>
                     </div>
                </div>
                
                <!-- Reports View -->
                <div id="reportsView" class="hidden">
                    <div class="flex justify-between items-center mb-6 no-print"><h2 class="text-2xl font-bold text-gray-800">Laporan</h2><button id="backToDashboardFromReports" class="text-blue-600">‹ Kembali</button></div>
                    <div class="bg-white rounded-xl shadow-md p-6 mb-6 no-print">
                        <div class="flex border-b mb-4"><button id="journalReportTab" class="px-4 py-2 font-medium report-tab tab-active">Laporan Jurnal</button><button id="attendanceReportTab" class="px-4 py-2 font-medium report-tab">Rekap Absensi</button><button id="summaryReportTab" class="px-4 py-2 font-medium report-tab">Ringkasan Umum</button></div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end"><input type="date" id="reportFromDate" class="w-full px-4 py-2 border rounded-lg"><input type="date" id="reportToDate" class="w-full px-4 py-2 border rounded-lg"><select id="reportClass" class="w-full px-4 py-2 border rounded-lg"><option value="">Semua Kelas</option><option>7A</option><option>7B</option><option>8A</option><option>8B</option><option>9A</option><option>9B</option></select><select id="reportSubject" class="w-full px-4 py-2 border rounded-lg"><option value="">Semua Mapel</option><option>Matematika</option><option>Bahasa Indonesia</option><option>IPA</option><option>IPS</option><option>Bahasa Inggris</option></select></div>
                        <div class="mt-4 flex justify-end"><button id="generateReportBtn" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg">Buat Laporan</button></div>
                    </div>
                    <div id="reportTabContent" class="print-container">
                        <div id="journalReportContent" class="report-content-item"></div>
                        <div id="attendanceReportContent" class="report-content-item hidden"></div>
                        <div id="summaryReportContent" class="report-content-item hidden"></div>
                    </div>
                    <div id="reportPlaceholder" class="text-center py-12 text-gray-500"><p>Pilih filter di atas dan klik "Buat Laporan".</p></div>
                </div>

            </main>
            <!-- Footer -->
            <footer class="bg-gray-800 text-white py-4 no-print"><div class="container mx-auto px-4 text-center text-sm"><p>© 2025 Jurnal Harian Guru.</p></div></footer>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="entryDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="bg-white rounded-xl shadow-xl max-w-2xl w-full mx-4 p-6 space-y-4"><h2 class="text-xl font-semibold">Detail Jurnal</h2><div><span class="text-sm text-gray-500">Tanggal</span><p id="detailDate"></p></div><div><span class="text-sm text-gray-500">Kelas</span><p id="detailClass"></p></div><div><span class="text-sm text-gray-500">Mata Pelajaran</span><p id="detailSubject"></p></div><div><span class="text-sm text-gray-500">Kegiatan</span><p id="detailActivity"></p></div><div class="pt-4 flex justify-end space-x-3"><button id="editEntryBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Edit</button><button id="deleteEntryBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg">Hapus</button><button id="closeDetailModal" class="px-4 py-2 bg-gray-200 rounded-lg">Tutup</button></div></div></div>
    <div id="editEntryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="bg-white rounded-xl shadow-xl max-w-2xl w-full mx-4 p-6 space-y-4"><h2 class="text-xl font-semibold">Edit Jurnal</h2><input type="hidden" id="editEntryId"><input type="date" id="editDate" class="w-full p-2 border rounded"><select id="editClass" class="w-full p-2 border rounded"><option>7A</option><option>7B</option></select><select id="editSubject" class="w-full p-2 border rounded"><option>Matematika</option></select><textarea id="editActivity" rows="5" class="w-full p-2 border rounded"></textarea><div class="pt-4 flex justify-end"><button id="updateEntryBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg">Simpan</button><button id="closeEditModal" class="px-4 py-2 bg-gray-200 rounded-lg">Batal</button></div></div></div>
    <div id="attendanceDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="bg-white rounded-xl shadow-xl max-w-4xl w-full mx-4 p-6 space-y-4"><h2 class="text-xl font-semibold">Detail Absensi</h2><div class="grid grid-cols-3 gap-4"><div><span class="text-sm text-gray-500">Tanggal</span><p id="attendanceDetailDate"></p></div><div><span class="text-sm text-gray-500">Kelas</span><p id="attendanceDetailClass"></p></div><div><span class="text-sm text-gray-500">Mapel</span><p id="attendanceDetailSubject"></p></div></div><div class="overflow-x-auto"><table class="min-w-full divide-y"><thead class="bg-gray-50"><tr><th class="p-3 text-left">No</th><th class="p-3 text-left">Nama</th><th class="p-3 text-left">Status</th><th class="p-3 text-left">Keterangan</th></tr></thead><tbody id="attendanceDetailBody"></tbody></table></div><div class="pt-4 flex justify-end"><button id="closeAttendanceDetailModal" class="px-4 py-2 bg-gray-200 rounded-lg">Tutup</button></div></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // =================================================================
            // CONFIGURATION
            // =================================================================
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz437f3T-V_4CR4FG-BvegAiiVoJHJG-jUEZxVdWpBIcj6L0YMHBADy2wylD77W8pz5BQ/exec';
            
            // =================================================================
            // GLOBAL STATE & VARIABLES
            // =================================================================
            let currentUser = null;
            let journalEntries = [];
            let attendanceData = [];
            let currentCalDate = new Date();
            
            // =================================================================
            // DOM ELEMENTS
            // =================================================================
            const loadingOverlay = document.getElementById('loadingOverlay');
            const authContainer = document.getElementById('authContainer');
            const appContainer = document.getElementById('appContainer');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const showRegisterBtn = document.getElementById('showRegister');
            const showLoginBtn = document.getElementById('showLogin');
            const welcomeMessage = document.getElementById('welcomeMessage');

            // --- Views ---
            const dashboardView = document.getElementById('dashboard');
            const allEntriesView = document.getElementById('allEntriesView');
            const attendanceView = document.getElementById('attendanceView');
            const reportsView = document.getElementById('reportsView');
            
            // =================================================================
            // INITIALIZATION
            // =================================================================
            checkSession();

            // =================================================================
            // AUTHENTICATION & ROUTING
            // =================================================================
            function checkSession() {
                const userSession = localStorage.getItem('currentUser');
                if (userSession) {
                    currentUser = JSON.parse(userSession);
                    showApp();
                } else {
                    showAuth();
                }
            }

            function showAuth() {
                authContainer.style.display = 'flex';
                appContainer.style.display = 'none';
            }

            async function showApp() {
                authContainer.style.display = 'none';
                appContainer.style.display = 'block';
                welcomeMessage.textContent = `Selamat datang, ${currentUser.nama}!`;
                await loadInitialData();
            }
            
            function showView(viewToShow) {
                [dashboardView, allEntriesView, attendanceView, reportsView].forEach(v => v.classList.add('hidden'));
                viewToShow.classList.remove('hidden');
            }

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = e.target.loginEmail.value;
                const password = e.target.loginPassword.value;
                if (email === 'admin@gmail.com' && password === 'admin69') {
                    currentUser = { nama: 'Administrator', email: 'Admin' };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    await showApp();
                    return;
                }
                showLoader(true);
                try {
                    const result = await callAppsScript('login', { email, password });
                    currentUser = result;
                    localStorage.setItem('currentUser', JSON.stringify(result));
                    await showApp();
                } catch (error) {
                    alert(`Login Gagal: ${error.message}`);
                } finally {
                    showLoader(false);
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoader(true);
                try {
                    const result = await callAppsScript('register', { nama: e.target.registerName.value, email: e.target.registerEmail.value, password: e.target.registerPassword.value });
                    alert(result.message);
                    e.target.reset();
                    document.getElementById('loginView').classList.remove('hidden');
                    document.getElementById('registerView').classList.add('hidden');
                } catch (error) {
                    alert(`Pendaftaran Gagal: ${error.message}`);
                } finally {
                    showLoader(false);
                }
            });

            document.getElementById('logoutBtn').addEventListener('click', () => {
                if (confirm('Yakin ingin keluar?')) {
                    localStorage.removeItem('currentUser');
                    showAuth();
                }
            });

            showRegisterBtn.addEventListener('click', (e) => { e.preventDefault(); document.getElementById('loginView').classList.add('hidden'); document.getElementById('registerView').classList.remove('hidden'); });
            showLoginBtn.addEventListener('click', (e) => { e.preventDefault(); document.getElementById('registerView').classList.add('hidden'); document.getElementById('loginView').classList.remove('hidden'); });

            // =================================================================
            // NAVIGATION
            // =================================================================
            document.getElementById('viewAllBtn').addEventListener('click', () => { showView(allEntriesView); renderAllEntries(); });
            document.getElementById('attendanceBtn').addEventListener('click', () => showView(attendanceView));
            document.getElementById('reportsBtn').addEventListener('click', () => {
                showView(reportsView);
                const today = new Date(), firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                document.getElementById('reportFromDate').value = firstDay.toISOString().split('T')[0];
                document.getElementById('reportToDate').value = today.toISOString().split('T')[0];
            });
            document.getElementById('backToDashboard').addEventListener('click', () => showView(dashboardView));
            document.getElementById('backToDashboardFromAttendance').addEventListener('click', () => showView(dashboardView));
            document.getElementById('backToDashboardFromReports').addEventListener('click', () => showView(dashboardView));

            // =================================================================
            // API & DATA
            // =================================================================
            function showLoader(show) { loadingOverlay.classList.toggle('hidden', !show); }

            async function callAppsScript(action, data = {}) {
                if (SCRIPT_URL.includes('MASUKKAN')) { throw new Error('URL Apps Script belum dikonfigurasi.'); }
                const response = await fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', redirect: 'follow', body: JSON.stringify({ action, data }) });
                const result = await response.json();
                if (result.status === 'error') throw new Error(result.message);
                return result.data;
            }

            async function loadInitialData() {
                showLoader(true);
                try {
                    [journalEntries, attendanceData] = await Promise.all([
                        callAppsScript('getJournal', { userEmail: currentUser.email }),
                        callAppsScript('getAttendance', { userEmail: currentUser.email })
                    ]);
                    const today = new Date();
                    document.getElementById('quickDate').value = today.toISOString().split('T')[0];
                    document.getElementById('attendanceDate').value = today.toISOString().split('T')[0];
                    updateDashboard();
                    showView(dashboardView);
                } catch (error) {
                    alert(`Gagal memuat data: ${error.message}`);
                } finally {
                    showLoader(false);
                }
            }
            
            function updateDashboard() {
                renderRecentEntries();
                updateStatistics();
                renderCalendar(currentCalDate.getFullYear(), currentCalDate.getMonth());
            }

            // =================================================================
            // JOURNAL & DASHBOARD LOGIC
            // =================================================================
            document.getElementById('quickSaveBtn').addEventListener('click', async () => {
                const entry = { date: document.getElementById('quickDate').value, class: document.getElementById('quickClass').value, subject: document.getElementById('quickSubject').value, activity: document.getElementById('quickActivity').value, userEmail: currentUser.email };
                if (!entry.date || !entry.class || !entry.subject || !entry.activity) { alert('Lengkapi semua field!'); return; }
                showLoader(true);
                try {
                    const result = await callAppsScript('saveJournal', entry);
                    entry.id = result.entryId;
                    journalEntries.push(entry);
                    document.getElementById('quickClass').value = ''; document.getElementById('quickSubject').value = ''; document.getElementById('quickActivity').value = '';
                    updateDashboard();
                    alert('Jurnal berhasil disimpan!');
                } catch (e) { alert(`Error: ${e.message}`); } finally { showLoader(false); }
            });

            function renderRecentEntries() {
                const container = document.getElementById('recentEntries'); container.innerHTML = '';
                [...journalEntries].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,5).forEach(e => {
                    const el = document.createElement('div'); el.className = 'bg-gray-50 rounded-lg p-4 hover:bg-gray-100 cursor-pointer';
                    el.innerHTML = `<div class="flex justify-between"><div><h4>${formatDate(e.date)} - ${e.class}</h4><p class="text-sm">${e.subject}</p></div></div><p class="mt-2 text-sm line-clamp-2">${e.activity}</p>`;
                    el.onclick = () => showEntryDetail(e);
                    container.appendChild(el);
                });
            }

            function updateStatistics() {
                document.getElementById('totalEntries').textContent = journalEntries.length;
                const startOfWeek = new Date(); startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
                document.getElementById('weekEntries').textContent = journalEntries.filter(e => new Date(e.date) >= startOfWeek).length;
                const classCounts = journalEntries.reduce((a, e) => { a[e.class] = (a[e.class] || 0) + 1; return a; }, {});
                document.getElementById('topClass').textContent = Object.keys(classCounts).reduce((a, b) => classCounts[a] > classCounts[b] ? a : b, '-');
            }

            function renderCalendar(year, month) {
                const monthNames = ['Januari','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'];
                document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
                const calendarDays = document.getElementById('calendarDays'); calendarDays.innerHTML = '';
                const firstDay = new Date(year, month, 1).getDay();
                for (let i=0; i<firstDay; i++) calendarDays.appendChild(document.createElement('div'));
                for (let day=1; day <= new Date(year, month + 1, 0).getDate(); day++) {
                    const el = document.createElement('div'); el.className = 'calendar-day'; el.textContent = day;
                    const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                    if (journalEntries.some(e => e.date === dateStr)) el.classList.add('has-entry');
                    el.onclick = () => { if(el.classList.contains('has-entry')) { showView(allEntriesView); document.getElementById('filterFromDate').value = dateStr; document.getElementById('filterToDate').value = dateStr; renderAllEntries(); }};
                    calendarDays.appendChild(el);
                }
            }
            document.getElementById('prevMonth').addEventListener('click', () => { currentCalDate.setMonth(currentCalDate.getMonth() - 1); renderCalendar(currentCalDate.getFullYear(), currentCalDate.getMonth()); });
            document.getElementById('nextMonth').addEventListener('click', () => { currentCalDate.setMonth(currentCalDate.getMonth() + 1); renderCalendar(currentCalDate.getFullYear(), currentCalDate.getMonth()); });

            document.getElementById('applyFilterBtn').addEventListener('click', renderAllEntries);
            function renderAllEntries() {
                const tbody = document.getElementById('entriesTableBody'); tbody.innerHTML = '';
                const from=document.getElementById('filterFromDate').value, to=document.getElementById('filterToDate').value, fClass=document.getElementById('filterClass').value, fSub=document.getElementById('filterSubject').value;
                let filtered = [...journalEntries].filter(e => (!from||e.date>=from)&&(!to||e.date<=to)&&(!fClass||e.class===fClass)&&(!fSub||e.subject===fSub));
                document.getElementById('noEntriesMessage').classList.toggle('hidden', filtered.length > 0);
                filtered.forEach(e => {
                    const row = tbody.insertRow();
                    row.innerHTML = `<td class="p-3">${formatDate(e.date)}</td><td class="p-3">${e.class}</td><td class="p-3">${e.subject}</td><td class="p-3 line-clamp-2">${e.activity}</td><td class="p-3 text-right"><button class="text-blue-600">Lihat</button></td>`;
                    row.querySelector('button').onclick = () => showEntryDetail(e);
                });
            }

            // --- Modal Logic for Journal ---
            function showEntryDetail(entry) {
                document.getElementById('detailDate').textContent = formatDate(entry.date);
                document.getElementById('detailClass').textContent = entry.class;
                document.getElementById('detailSubject').textContent = entry.subject;
                document.getElementById('detailActivity').textContent = entry.activity;
                document.getElementById('editEntryBtn').onclick = () => {
                    document.getElementById('editEntryId').value = entry.id; document.getElementById('editDate').value = entry.date;
                    document.getElementById('editClass').value = entry.class; document.getElementById('editSubject').value = entry.subject; document.getElementById('editActivity').value = entry.activity;
                    document.getElementById('entryDetailModal').classList.add('hidden'); document.getElementById('editEntryModal').classList.remove('hidden');
                };
                document.getElementById('deleteEntryBtn').onclick = async () => {
                    if (confirm('Yakin hapus jurnal ini?')) {
                        showLoader(true);
                        try { await callAppsScript('deleteJournal', { entryId: entry.id, userEmail: currentUser.email });
                            journalEntries = journalEntries.filter(j => j.id !== entry.id);
                            updateDashboard(); document.getElementById('entryDetailModal').classList.add('hidden');
                        } catch (e) { alert(`Error: ${e.message}`); } finally { showLoader(false); }
                    }
                };
                document.getElementById('entryDetailModal').classList.remove('hidden');
            }
            document.getElementById('closeDetailModal').addEventListener('click', () => document.getElementById('entryDetailModal').classList.add('hidden'));
            document.getElementById('closeEditModal').addEventListener('click', () => document.getElementById('editEntryModal').classList.add('hidden'));
            document.getElementById('updateEntryBtn').addEventListener('click', async () => {
                const entry = { id: document.getElementById('editEntryId').value, date: document.getElementById('editDate').value, class: document.getElementById('editClass').value, subject: document.getElementById('editSubject').value, activity: document.getElementById('editActivity').value, userEmail: currentUser.email };
                showLoader(true);
                try {
                    await callAppsScript('saveJournal', entry);
                    const index = journalEntries.findIndex(j => j.id === entry.id);
                    if(index > -1) journalEntries[index] = entry;
                    updateDashboard(); document.getElementById('editEntryModal').classList.add('hidden');
                } catch(e){ alert(`Error: ${e.message}`); } finally { showLoader(false); }
            });

            // =================================================================
            // ATTENDANCE LOGIC
            // =================================================================
            document.getElementById('newAttendanceTab').addEventListener('click', (e) => { e.target.classList.add('tab-active'); document.getElementById('attendanceHistoryTab').classList.remove('tab-active'); document.getElementById('newAttendanceForm').classList.remove('hidden'); document.getElementById('attendanceHistoryContent').classList.add('hidden'); });
            document.getElementById('attendanceHistoryTab').addEventListener('click', (e) => { e.target.classList.add('tab-active'); document.getElementById('newAttendanceTab').classList.remove('tab-active'); document.getElementById('newAttendanceForm').classList.add('hidden'); document.getElementById('attendanceHistoryContent').classList.remove('hidden'); renderAttendanceHistory(); });
            
            document.getElementById('loadStudentsBtn').addEventListener('click', async () => {
                const className = document.getElementById('attendanceClass').value;
                if (!className) { alert('Pilih kelas!'); return; }
                showLoader(true);
                try {
                    const students = await callAppsScript('getStudentsByClass', { className });
                    const tbody = document.getElementById('studentListBody'); tbody.innerHTML = '';
                    students.forEach((s, i) => {
                        const row = tbody.insertRow(); row.setAttribute('data-student-id', s.id);
                        row.innerHTML = `<td class="p-3">${i+1}</td><td class="p-3 student-name">${s.name}</td><td class="p-3"><select class="w-full p-1 border rounded student-status"><option value="hadir">Hadir</option><option value="sakit">Sakit</option><option value="izin">Izin</option><option value="tidak_hadir">Alpha</option></select></td><td class="p-3"><input type="text" class="w-full p-1 border rounded student-note" placeholder="Ket..."></td>`;
                    });
                    document.getElementById('studentListContainer').classList.remove('hidden');
                } catch(e) { alert(`Error: ${e.message}`); } finally { showLoader(false); }
            });

            document.getElementById('saveAttendanceBtn').addEventListener('click', async () => {
                const record = { date: document.getElementById('attendanceDate').value, class: document.getElementById('attendanceClass').value, subject: document.getElementById('attendanceSubject').value, userEmail: currentUser.email, students: [] };
                if (!record.date || !record.class || !record.subject) { alert('Lengkapi data absensi!'); return; }
                document.querySelectorAll('#studentListBody tr').forEach(row => {
                    record.students.push({ id: row.dataset.studentId, name: row.querySelector('.student-name').textContent, status: row.querySelector('.student-status').value, note: row.querySelector('.student-note').value });
                });
                showLoader(true);
                try {
                    const result = await callAppsScript('saveAttendance', record);
                    record.id = result.attendanceId;
                    attendanceData.push(record);
                    alert('Absensi berhasil disimpan!');
                    document.getElementById('attendanceHistoryTab').click();
                } catch(e) { alert(`Error: ${e.message}`); } finally { showLoader(false); }
            });

            function renderAttendanceHistory() {
                const tbody = document.getElementById('attendanceHistoryBody'); tbody.innerHTML = '';
                document.getElementById('noAttendanceMessage').classList.toggle('hidden', attendanceData.length > 0);
                [...attendanceData].sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(a => {
                    const present = a.students.filter(s => s.status === 'hadir').length, absent = a.students.length - present;
                    const row = tbody.insertRow();
                    row.innerHTML = `<td class="p-3">${formatDate(a.date)}</td><td class="p-3">${a.class}</td><td class="p-3">${a.subject}</td><td class="p-3 text-green-600">${present}</td><td class="p-3 text-red-600">${absent}</td><td class="p-3 text-right"><button class="text-blue-600">Detail</button></td>`;
                    row.querySelector('button').onclick = () => showAttendanceDetail(a);
                });
            }

            function showAttendanceDetail(att) {
                document.getElementById('attendanceDetailDate').textContent = formatDate(att.date);
                document.getElementById('attendanceDetailClass').textContent = att.class;
                document.getElementById('attendanceDetailSubject').textContent = att.subject;
                const tbody = document.getElementById('attendanceDetailBody'); tbody.innerHTML = '';
                att.students.forEach((s, i) => {
                    const row = tbody.insertRow();
                    row.innerHTML = `<td class="p-3">${i+1}</td><td class="p-3">${s.name}</td><td class="p-3">${s.status}</td><td class="p-3">${s.note || '-'}</td>`;
                });
                document.getElementById('attendanceDetailModal').classList.remove('hidden');
            }
            document.getElementById('closeAttendanceDetailModal').addEventListener('click', () => document.getElementById('attendanceDetailModal').classList.add('hidden'));
            
            // =================================================================
            // REPORTS SECTION LOGIC
            // =================================================================
            let statusChart = null, classChart = null;

            document.querySelectorAll('.report-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.report-tab').forEach(t => t.classList.remove('tab-active'));
                    tab.classList.add('tab-active');
                    document.querySelectorAll('.report-content-item').forEach(c => { c.innerHTML = ''; c.classList.add('hidden'); });
                    document.getElementById('reportPlaceholder').classList.remove('hidden');
                    const contentToShow = document.getElementById(tab.id.replace('Tab', 'Content'));
                    if (contentToShow) contentToShow.classList.remove('hidden');
                });
            });

            document.getElementById('generateReportBtn').addEventListener('click', () => {
                const activeTabId = document.querySelector('.report-tab.tab-active').id;
                const filters = { from: document.getElementById('reportFromDate').value, to: document.getElementById('reportToDate').value, class: document.getElementById('reportClass').value, subject: document.getElementById('reportSubject').value };
                if (!filters.from || !filters.to) { alert('Pilih rentang tanggal.'); return; }
                document.getElementById('reportPlaceholder').classList.add('hidden');
                
                if (activeTabId === 'journalReportTab') generateJournalReport(filters);
                else if (activeTabId === 'attendanceReportTab') generateDetailedAttendanceReport(filters);
                else if (activeTabId === 'summaryReportTab') generateSummaryReport(filters);
            });

            function generateJournalReport(filters) {
                const container = document.getElementById('journalReportContent');
                let filtered = journalEntries.filter(e => (!filters.from||e.date>=filters.from)&&(!filters.to||e.date<=filters.to)&&(!filters.class||e.class===filters.class)&&(!filters.subject||e.subject===filters.subject));
                if (filtered.length === 0) { container.innerHTML = '<p class="text-center p-8">Tidak ada data jurnal ditemukan.</p>'; return; }
                let tableHTML = `<thead class="bg-gray-50"><tr><th class="p-3 text-left text-xs uppercase">No</th><th class="p-3 text-left text-xs uppercase">Tanggal</th><th class="p-3 text-left text-xs uppercase">Kelas</th><th class="p-3 text-left text-xs uppercase">Mapel</th><th class="p-3 text-left text-xs uppercase">Kegiatan</th></tr></thead><tbody>`;
                filtered.forEach((e, i) => { tableHTML += `<tr><td class="p-3">${i+1}</td><td class="p-3">${formatDate(e.date)}</td><td class="p-3">${e.class}</td><td class="p-3">${e.subject}</td><td class="p-3">${e.activity.replace(/\n/g, '<br>')}</td></tr>`; });
                container.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-semibold mb-4">Laporan Jurnal Mengajar</h3><div class="overflow-x-auto"><table class="min-w-full divide-y">${tableHTML}</tbody></table></div></div>`;
            }

            function generateSummaryReport(filters) {
                const container = document.getElementById('summaryReportContent');
                let journals = journalEntries.filter(e=>(!filters.from||e.date>=filters.from)&&(!filters.to||e.date<=filters.to)&&(!filters.class||e.class===filters.class)&&(!filters.subject||e.subject===filters.subject));
                let attendance = attendanceData.filter(a=>(!filters.from||a.date>=filters.from)&&(!filters.to||a.date<=filters.to)&&(!filters.class||a.class===filters.class)&&(!filters.subject||a.subject===filters.subject));
                let total = 0, present = 0;
                attendance.forEach(r => r.students.forEach(s => { total++; if (s.status === 'hadir') present++; }));
                const percentage = total > 0 ? ((present / total) * 100).toFixed(1) : 0;
                container.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-semibold mb-4">Ringkasan Umum</h3><div class="grid grid-cols-2 gap-4"><div class="border p-4 rounded text-center"><h4>Total Entri Jurnal</h4><p class="text-4xl font-bold">${journals.length}</p></div><div class="border p-4 rounded text-center"><h4>Tingkat Kehadiran</h4><p class="text-4xl font-bold">${percentage}%</p></div></div></div>`;
            }

            function generateDetailedAttendanceReport(filters) {
                const container = document.getElementById('attendanceReportContent');
                container.innerHTML = `<div class="bg-white rounded-xl shadow-md p-6 mb-6"><h3 class="text-lg font-semibold mb-4">Ringkasan Absensi</h3><div class="grid grid-cols-4 gap-4"><div class="bg-blue-50 p-4 rounded-lg"><p class="text-sm">Total Sesi</p><p id="totalSessions" class="text-2xl font-bold">0</p></div><div class="bg-green-50 p-4 rounded-lg"><p class="text-sm">Total Hadir</p><p id="totalPresent" class="text-2xl font-bold">0</p></div><div class="bg-red-50 p-4 rounded-lg"><p class="text-sm">Total Tdk Hadir</p><p id="totalAbsent" class="text-2xl font-bold">0</p></div><div class="bg-yellow-50 p-4 rounded-lg"><p class="text-sm">% Hadir</p><p id="attendancePercentage" class="text-2xl font-bold">0%</p></div></div></div><div class="grid md:grid-cols-2 gap-6 mb-6"><div class="bg-white rounded-xl p-6 shadow-md"><h3 class="text-lg font-semibold mb-4">Status Kehadiran</h3><div class="relative h-[300px]"><canvas id="attendanceStatusChart"></canvas></div></div><div class="bg-white rounded-xl p-6 shadow-md"><h3 class="text-lg font-semibold mb-4">Kehadiran per Kelas</h3><div class="relative h-[300px]"><canvas id="attendanceByClassChart"></canvas></div></div></div><div class="bg-white p-6 rounded-xl shadow-md mb-6"><div class="flex justify-between items-center mb-4"><h3>Detail Sesi</h3><button id="printReportBtnInternal" class="px-4 py-2 bg-gray-600 text-white rounded no-print">Cetak</button></div><div class="overflow-x-auto"><table id="detailedAttendanceTable" class="min-w-full divide-y"></table></div></div><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-lg font-semibold mb-4">Analisis Kehadiran Siswa</h3><div class="mb-4"><select id="classAnalysis" class="w-full md:w-1/3 p-2 border rounded"></select></div><div id="studentAnalysisContent" class="hidden"><div class="overflow-x-auto"><table class="min-w-full divide-y"><thead class="bg-gray-50"><tr><th class="p-3 text-left text-xs uppercase">No</th><th class="p-3 text-left text-xs uppercase">Nama</th><th class="p-3 text-left text-xs uppercase">H</th><th class="p-3 text-left text-xs uppercase">S</th><th class="p-3 text-left text-xs uppercase">I</th><th class="p-3 text-left text-xs uppercase">A</th><th class="p-3 text-left text-xs uppercase">%</th></tr></thead><tbody id="studentAnalysisTableBody"></tbody></table></div></div></div>`;
                
                let filtered = attendanceData.filter(a=>(!filters.from||a.date>=filters.from)&&(!filters.to||a.date<=filters.to)&&(!filters.class||a.class===filters.class)&&(!filters.subject||a.subject===filters.subject));
                
                let totalSessions=filtered.length,totalPresent=0,totalSick=0,totalPermit=0,totalAbsent=0;
                filtered.forEach(s=>s.students.forEach(st=>{if(st.status==='hadir')totalPresent++;else if(st.status==='sakit')totalSick++;else if(st.status==='izin')totalPermit++;else totalAbsent++;}));
                const totalRecords = totalPresent+totalSick+totalPermit+totalAbsent;
                container.querySelector('#totalSessions').textContent=totalSessions;
                container.querySelector('#totalPresent').textContent=totalPresent;
                container.querySelector('#totalAbsent').textContent=totalSick+totalPermit+totalAbsent;
                container.querySelector('#attendancePercentage').textContent=`${totalRecords > 0 ? Math.round((totalPresent/totalRecords)*100) : 0}%`;

                if(statusChart) statusChart.destroy();
                statusChart = new Chart(container.querySelector('#attendanceStatusChart').getContext('2d'),{type:'doughnut',data:{labels:['Hadir','Sakit','Izin','Alpha'],datasets:[{data:[totalPresent,totalSick,totalPermit,totalAbsent],backgroundColor:['#22c55e','#facc15','#3b82f6','#ef4444']}]},options:{responsive:true,maintainAspectRatio:false}});
                
                const classCounts = filtered.reduce((acc, s)=>{acc[s.class]=(acc[s.class]||0)+s.students.filter(st=>st.status==='hadir').length;return acc;},{});
                if(classChart) classChart.destroy();
                classChart = new Chart(container.querySelector('#attendanceByClassChart').getContext('2d'),{type:'bar',data:{labels:Object.keys(classCounts),datasets:[{label:'Total Kehadiran',data:Object.values(classCounts),backgroundColor:'#3b82f6'}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}});

                let tableHTML = `<thead class="bg-gray-50"><tr><th class="p-3 text-left text-xs uppercase">Tgl</th><th class="p-3 text-left text-xs uppercase">Kelas</th><th class="p-3 text-left text-xs uppercase">Mapel</th><th class="p-3 text-left text-xs uppercase">H</th><th class="p-3 text-left text-xs uppercase">S</th><th class="p-3 text-left text-xs uppercase">I</th><th class="p-3 text-left text-xs uppercase">A</th></tr></thead><tbody>`;
                filtered.forEach(s=>{const h=s.students.filter(st=>st.status==='hadir').length,sk=s.students.filter(st=>st.status==='sakit').length,i=s.students.filter(st=>st.status==='izin').length,a=s.students.filter(st=>st.status==='tidak_hadir').length;tableHTML+=`<tr><td class="p-3">${formatDate(s.date)}</td><td>${s.class}</td><td>${s.subject}</td><td>${h}</td><td>${sk}</td><td>${i}</td><td>${a}</td></tr>`;});
                container.querySelector('#detailedAttendanceTable').innerHTML = tableHTML + `</tbody>`;

                const classSelect = container.querySelector('#classAnalysis'); classSelect.innerHTML='<option value="">Pilih Kelas</option>';
                [...new Set(filtered.map(i=>i.class))].forEach(c=>classSelect.innerHTML+=`<option value="${c}">${c}</option>`);
                classSelect.onchange=(e)=>showStudentAnalysis(e.target.value, filtered);
                container.querySelector('#printReportBtnInternal').onclick=()=>window.print();
            }

            async function showStudentAnalysis(className, filteredData) {
                const analysisContainer = document.getElementById('studentAnalysisContent'), tbody = document.getElementById('studentAnalysisTableBody');
                if(!className || !analysisContainer) { if(analysisContainer) analysisContainer.classList.add('hidden'); return; }
                showLoader(true);
                try {
                    const students = await callAppsScript('getStudentsByClass', {className});
                    const stats = students.reduce((acc,s)=>{acc[s.name]={name:s.name,h:0,s:0,i:0,a:0,total:0};return acc;},{});
                    filteredData.filter(a=>a.class===className).forEach(session=>{
                        Object.values(stats).forEach(stat=>stat.total++);
                        session.students.forEach(rec=>{if(stats[rec.name]){if(rec.status==='hadir')stats[rec.name].h++;else if(rec.status==='sakit')stats[rec.name].s++;else if(rec.status==='izin')stats[rec.name].i++;else stats[rec.name].a++;}});
                    });
                    let html='';
                    Object.values(stats).forEach((s,i)=>{const p=s.total>0?Math.round((s.h/s.total)*100):0;html+=`<tr><td class="p-3">${i+1}</td><td>${s.name}</td><td>${s.h}</td><td>${s.s}</td><td>${s.i}</td><td>${s.a}</td><td class="font-semibold">${p}%</td></tr>`;});
                    tbody.innerHTML = html;
                    analysisContainer.classList.remove('hidden');
                } catch(e){alert(`Error: ${e.message}`);} finally {showLoader(false);}
            }
            
            function formatDate(dateString) {
                if (!dateString) return '';
                return new Date(dateString).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
            }
        });
    </script>
</body>
</html>
